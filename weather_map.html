<!DOCTYPE html>
<html>
<head>
    <title>AJAX Template</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
</head>
<style>
    h1 {
        color: lightgrey;
        text-align: center;
    }
    body {
        background-color: black;
    }
    #custom .card {
        background-color: lightgrey;
    }
    #custom #map {
        height: 50vh;
    }
</style>
<body id="custom">
<br>
<h1>Weather Application</h1>
<br>
<h3 id="location"></h3>
<div class="container">
    <div class="card-deck">
        <div id="today" class="card border-secondary"></div>
        <div id="tomorrow" class="card border-secondary"></div>
        <div id="day-after" class="card border-secondary"></div>
    </div>
    <br>
    <div class="map-stuff">
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Search A City" id="city-search-input" aria-label="Search A City" aria-describedby="button-addon2">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="get-weather-button">Get Weather</button>
            </div>
        </div>
        <div id="map"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script src="js/keys.js"></script>
<script src="js/skycons.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>


<script>
    (() => {
        'use strict';
        $(document).ready(() => {
            //darksky vars
            const iconsObj = {"clearday": {"icon": Skycons.CLEAR_DAY, "color": "#fcba03"}, "clearnight": {"icon": Skycons.CLEAR_NIGHT, "color": "#fcba03"}, "rain": {"icon": Skycons.RAIN, "color": "blue"}, "snow": {"icon": Skycons.SNOW, "color": "white"}, "sleet": {"icon": Skycons.SLEET, "color": "white"}, "wind": {"icon": Skycons.WIND, "color": "white"}, "fog": {"icon": Skycons.FOG, "color": "white"}, cloudy: {"icon": Skycons.CLOUDY, "color": "grey"}, "partlycloudyday": {"icon": Skycons.PARTLY_CLOUDY_DAY, "color": "#fcba03"}, "partlycloudynight": {"icon": Skycons.PARTLY_CLOUDY_NIGHT, "color": "grey"}};
            //
            //darksky getWeather updates all weather
            const getWeather = function (inputArr) {
                $.ajax(`https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/${DARK_SKY_KEY}/${inputArr[0]},${inputArr[1]}`).done(function(data) {
                    let dailyDataArr = data['daily']['data']
                    for (let i = 0; i <= 2; i++) {
                        let date = new Date(dailyDataArr[i]['time'] * 1000);
                        date = date.toDateString();
                        let summary = dailyDataArr[i]['summary'];
                        let icon = dailyDataArr[i]['icon'];
                        let high = Math.ceil(dailyDataArr[i]['temperatureHigh']);
                        let low = Math.ceil(dailyDataArr[i]['temperatureLow']);
                        let humidity = (dailyDataArr[i]['humidity']) * 100 + '%';
                        let wind = dailyDataArr[i]['windSpeed'];
                        let pressure = dailyDataArr[i]['pressure'];
                        if (i === 0) {
                            $('#today').html(`<div class="card-body m-auto d-flex flex-column align-items-center"><div class="card-title">${date}</div><canvas id="icon1" width="128" height="128"></canvas><div class="card-text" id="today-temps">Temperature: ${high}&deg; / ${low}&deg;</div><div class="card-text" id="today-humidity">Humidity: ${humidity}</div><div class="card-text" id="today-wind">Wind Speed: ${wind}</div><div class="card-text" id="today-pressure">Pressure: ${pressure}</div></div>`);
                            var skyconsToday = new Skycons({"color": iconsObj[icon.split('-').join('')]["color"]});
                            skyconsToday.add("icon1", iconsObj[icon.split("-").join('')]["icon"]);
                            skyconsToday.play();
                        } else if (i === 1) {
                            $('#tomorrow').html(`<div class="card-body m-auto d-flex flex-column align-items-center"><div class="card-title">${date}</div><canvas id="icon2" width="128" height="128"></canvas><div class="card-text" id="tomorrow-temps">Temperature: ${high}&deg; / ${low}&deg;</div><div class="card-text" id="tomorrow-humidity">Humidity: ${humidity}</div><div class="card-text" id="tomorrow-wind">Wind Speed: ${wind}</div><div class="card-text" id="tomorrow-pressure">Pressure: ${pressure}</div></div>`);
                            var skyconsTomorrow = new Skycons({"color": iconsObj[icon.split('-').join('')]["color"]});
                            skyconsTomorrow.add("icon2", iconsObj[icon.split("-").join('')]["icon"]);
                            skyconsTomorrow.play();
                        } else if (i === 2) {
                            $('#day-after').html(`<div class="card-body m-auto d-flex flex-column align-items-center"><div class="card-title">${date}</div><canvas id="icon3" width="128" height="128"></canvas><div class="card-text" id="day-after-temps">Temperature: ${high}&deg; / ${low}&deg;</div><div class="card-text" id="day-after-humidity">Humidity: ${humidity}</div><div class="card-text" id="day-after-wind">Wind Speed: ${wind}</div><div class="card-text" id="day-after-pressure">Pressure: ${pressure}</div></div>`);
                            var skyconsDayAfter = new Skycons({"color": iconsObj[icon.split('-').join('')]["color"]});
                            skyconsDayAfter.add("icon3", iconsObj[icon.split("-").join('')]["icon"]);
                            skyconsDayAfter.play();
                        } else {
                            console.log("error in getWeather");
                        }
                    }
                });
            // mapbox markers



            };
            //
            //mapbox functions
            function geoCenter(search, token) {
                var baseUrl = 'https://api.mapbox.com';
                var endPoint = '/geocoding/v5/mapbox.places/';
                return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
                    .then(function(res) {
                        return res.json();
                        // to get all the data from the request, comment out the following three lines...
                    }).then(function(data) {
                        return data.features[0].center;
                    });
            };
            function geoSearch(search, token) {
                var baseUrl = 'https://api.mapbox.com';
                var endPoint = '/geocoding/v5/mapbox.places/';
                return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
                    .then(function(res) {
                        return res.json();
                    })
                    .then(function(data) {
                        return data.features[0]["center"];
                    })
                    .then(function(result) {
                        console.log(result)
                        return [result[1], result[0]];
                    });
            };
            //
            //mapbox vars
            mapboxgl.accessToken = mapboxToken;
            var mapOptions = {
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-streets-v11',
                center: [-98.4936, 29.4241],
                zoom: 5
            };
            var markerOptions = {
                color: "ff0000",
                draggable: true
            };


            const map = new mapboxgl.Map(mapOptions);
            const marker = new mapboxgl.Marker(
                markerOptions)
                .setLngLat([-98.4936, 29.4241])
                .addTo(map);

            geoCenter("San Antonio, Texas", mapboxToken).then(result => {
                map.setCenter(result);
                // marker.setLngLat(result);
            });
            // getWeather("29.4241", "-98.4936");
            getWeather([29.4241, -98.4936]);
            $('#get-weather-button').click(function() {
               // getWeather(geoSearch(($('#city-search-input').val()),mapboxToken));
               geoCenter($('#city-search-input').val(), mapboxToken).then(result => {
                    map.setCenter(result);
                    marker.setLngLat(result);
                });
               geoSearch($('#city-search-input').val(), mapboxToken)
                   .then(result => getWeather(result));
               $('#city-search-input').val('');
            });
            marker.on('dragend', (function() {
                let lngLat = marker.getLngLat();
                let searchCoords = [lngLat['lat'], lngLat['lng']];
                getWeather(searchCoords);
                geoCenter([lngLat['lng'], lngLat['lat']], mapboxToken).then(result => {
                    map.setCenter(result);
                });
            }));


        });
    })();
</script>
</body>
</html>